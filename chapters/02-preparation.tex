\chapter{研究の準備}\label{cha:Preparation}
本章では、本研究に必要な前提知識について説明する。


\section{入力対象の画像}\label{sec:input_images}
本提案手法の入力対象である画像については、以下の条件を全て満たす画像とする。
なお、帳票は帳簿と伝票の総称であり\cite{帳票}、電子文書は、Wordやテキストファイルなど、デジタル情報として作成した文書を指し、電子化文書は紙媒体の書類をスキャンしたPDFファイルや画像などの形式で保存した文書を指す\cite{電子文書と電子化文書}。
電子化文書については、本提案手法においては、スマートフォンのカメラで撮影した帳票を想定する。

\begin{itemize}
	\item 帳票の電子文書または電子化文書の画像である。
	\item 帳票の背景が白色である。
	\item 日本語かつ横書きの帳票である。
	\item 文字が手書きではない。
	\item 入力欄が矩形または下線で示されている。
\end{itemize}

なお、入力対象とする画像の座標系は、画像左上隅画素を原点(0,0)とし、右方向をX軸の正の向き、下方向をY軸の正の向きと定義する。

\section{バリデーションチェック}\label{sec:validation_check}


\section{OpenCV}\label{sec:OpenCV}
OpenCV(Open Source Computer Vision Library) は、コンピュータビジョン向けのオープンソースライブラリである\cite{OpenCV}。
本研究では、OpenCVに用意されている以下の関数を用いる。

\paragraph{imread関数}
imread関数は、画像ファイルを読み込む関数である。

\paragraph{cvtColor関数}
cvtColor関数は、画像の色空間を変換する関数である。
本研究では、読み込んだ画像をグレースケール化するために用いる。
これは、カラー画像をグレースケール化することにより、画像処理に必要な計算量を減らす目的がある。

\paragraph{getStructuringElement関数}
getStructuringElement関数は、カーネルを作成する関数である。
カーネルは、ガウシアンフィルタ(GaussianBlur関数で後述)や膨張処理(dilate関数で後述)など、注目画素の周囲の画素値を参照する画像処理において、周囲の画素を行列として、周囲の画素を参照する計算に付ける重みである。
例えば、3行3列のカーネルは、注目画素とその周囲8画素の画素値の、計9画素の画素値を用いて計算を行う。
第一引数として、カーネルの形状を矩形、楕円、十字から決定する。
また、第二引数では、カーネルの大きさを指定する。
本研究では、矩形領域座標取得用画像処理(\ref{subsec:image_processing_for_rect_coords_obtainment}節で後述)に必要な画像処理の一部として用いる。

\paragraph{GaussianBlur関数}
GaussianBlur関数は、ガウシアンフィルタを適用することにより、画像内の白色ノイズを除去する関数である。
ガウシアンフィルタは、注目画素との距離に応じて重みを変えるガウシアンカーネルを用いた、画像の平滑化によって白色ノイズを除去するフィルタである。
標準偏差を$0$とするによって、カーネルの大きさから自動的に標準偏差を計算する\cite{ガウシアンフィルタ}。
本研究では、矩形領域座標取得用画像処理(\ref{subsec:image_processing_for_rect_coords_obtainment}節で後述)に必要な画像処理の一部として用いる。

\paragraph{threshold関数}
threshold関数は、画像を二値化する関数である。
第一引数として、グレースケール画像を指定する。
また、第二引数では、二値化する際の閾値を指定し、第三引数では、二値化後の画素値の最大値を指定する。
さらに、第四引数では、二値化における閾値処理手法を指定する。
本研究で用いる閾値処理手法を指定する変数を、以下に示す。

\begin{itemize}
	\item THRESH\_BINARY\\
		文字情報取得用画像処理(\ref{subsec:image_processing_for_char_recognition}節で後述)で設定する。
		大津の二値化\cite{大津の二値化}を用いる場合は、大津の二値化によって決定した閾値を基準に、ある注目画素の画素値が閾値よりも小さい場合は画素値を第三引数で設定する値に変換し、閾値よりも大きい場合は画素数を0に変換して二値化する。
	\item THRESH\_BINARY\_INV\\
		下線部領域座標取得用画像処理(\ref{subsec:image_processing_for_underline_coords_obtainment}節で後述)で設定する。
		大津の二値化を用いる場合は、大津の二値化によって決定した閾値を基準に、ある注目画素の画素値が閾値よりも小さい場合は画素値を0に、閾値よりも大きい場合は画素値を第三引数で設定する値に変換して二値化する。
	\item THRESH\_TOZERO\_INV\\
		矩形領域座標取得用画像処理(\ref{subsec:image_processing_for_rect_coords_obtainment}節で後述)で設定する。
		大津の二値化を用いる場合は、大津の二値化によって決定した閾値を基準に、ある注目画素の画素値が閾値よりも小さい場合は画素値を変換せず、閾値よりも大きい場合は画素値を第三引数で設定する値に変換して二値化する。
\end{itemize}

大津の二値化(判別分析法)は、画素値のヒストグラムにおけるクラス間分散とクラス内分散の比である分離度が最大となる閾値を求める手法である\cite{大津の二値化}。
大津の二値化を用いることによって、画像に適する閾値を自動で決定することができる。
大津の二値化による閾値処理を設定する場合は、第四引数に、変数THRESH\_OTSUを加算演算子+で接続する。
なお、一般に8ビット画像について、画素値は0に近づくほど黒を、255に近づくほど白を表すとされている\cite{画素値}。
本研究では、大津の二値化を用いて、閾値を決定する。

\paragraph{dilate関数}
dilate関数は、画像に膨張処理を施す関数である。
膨張処理は、ある注目画素について、一定周囲の画素集合内に白色に二値化した画素がある場合は、注目画素の画素値をカーネル内画素の最大画素値に変更する処理である\cite{膨張処理}。
第一引数として、二値化処理後の画像である、二値画像を指定する。
また、第二引数では、カーネルを指定する。
さらに、第三引数では、膨張処理を適用する回数を指定する。
本研究では、矩形領域座標取得用画像処理(\ref{subsec:image_processing_for_rect_coords_obtainment}節で後述)で施す画像処理のひとつとして用いる。

\paragraph{Canny関数}
Canny関数は、Canny法によってエッジ検出を行う関数である。
エッジ検出は、画像内の輝度差を検出することにより、物体や領域の境界を識別する処理である\cite{エッジ検出}。
Canny法は、ガウシアンフィルタでノイズを除去し、ソーベルフィルタでエッジの勾配と方向を検出し、エッジを細線化した後に勾配と方向からエッジ検出を行う手法である。
Canny法におけるエッジ検出の閾値処理については、最低閾値と最大閾値を決め、画素値の微分値が最大閾値よりも大きい画素と、それらに隣接しており、かつ最低閾値よりも大きく最大閾値よりも小さい画素のみをエッジとみなすヒステリシス閾値処理を用いる\cite{Canny法}。
本研究では、下線部領域座標取得用画像処理(\ref{subsec:image_processing_for_underline_coords_obtainment}節で後述)で下線部領域座標の取得に必要な画像処理の一部として用いる。

\paragraph{findContours関数}
findContours関数は、画像内にある物体の輪郭を検出する関数である。
第一引数として、二値化処理後の画像である二値画像を指定する。
また、第二引数では、検出する輪郭と、それらを保存する構造を決定する変数を指定する。
本研究では、全ての輪郭を検出し、それらを外側から順に入れ子とした階層構造とするRECT\_TREEを指定する。
さらに、第三引数では、輪郭となる頂点の近似法を決定する変数を指定する。
本研究では、輪郭を表現するにあたり、冗長な点の情報を削除するCHAIN\_APPROX\_SIMPLEを用いる。
例えば、矩形であれば、各辺にある全ての点の座標を保存する必要はなく、4つの頂点の座標を保存することで、矩形の輪郭を表現できるため、それ以外の座標情報を削除する\cite{輪郭検出}。
本研究では、矩形領域座標取得処理(\ref{subsec:rect_coords_obtainment_processing}節で後述)で矩形の輪郭を検出するために用いる。

\paragraph{HoughLinesP関数}
HoughLinesP関数は、ハフ変換によって画像内にある直線を検出する関数である。
ハフ変換は、二値画像中の直線や円を検出する手法の1つであり、画像空間から$\rho$-$\theta$空間に、座標系を変換することで、直線や円を検出する手法である。
直線を検出する場合は、極座標の二次元平面に変換する。
直線上のある点の座標を$(x, y)$とすると、$\rho$は、座標$(x, y)$を通る直線に対して、原点から垂線を下ろしたときの長さ、$\theta$は、座標$(x, y)$を通る直線に対して、原点から垂線を下ろしたときに、X軸となす角度と表すことができる。
よって、以下の式が成り立つ。

\begin{equation}\label{eq:hough}
	\rho = x\cos\theta + y\sin\theta
\end{equation}

座標$(x, y)$を通る直線は無数に存在するため、式\ref{eq:hough}を満たす$(\rho, \theta)$も無数に存在する。
縦軸を$\rho$、横軸を$\theta$として、それらの$(\rho, \theta)$を、$\rho$-$\theta$空間に射影すると、線を図示できる。
この座標系の変換を、直線上の他にある$(x, y)$以外の座標に対して行ったとき、$\rho$-$\theta$空間に交点が存在する。
この操作を全画素に対して行い、$\rho$-$\theta$空間で多くの線が重なっている点$(\rho, \theta)$から、直線が存在する可能性が高い$(\rho, \theta)$を探し、直線を検出する\cite{ハフ変換}。
HoughLinesP関数を用いる際は、以下の順で引数を渡す\cite{HoughLinesP関数の引数}。
\begin{enumerate}
	\item 直線を検出する二値画像のパス
	\item 式\ref{eq:hough}における、$\rho$の値
	\item 式\ref{eq:hough}における、$\theta$の値
	\item 直線とみなす集合した点の数の閾値
	\item 直線とみなす最小の長さ
	\item 同一直線とみなす2つの点の間隔の広さ
\end{enumerate}
本研究では、下線部領域座標取得処理(\ref{subsec:underline_coords_obtainment_processing}節で後述)で直線を検出するために用いる。

\paragraph{drawContours関数}
drawContours関数は、輪郭を画像に描画する関数である。
drawContours関数を用いる際は、以下の順で引数を渡す\cite{輪郭描画}。
\begin{enumerate}
	\item 輪郭を描画する画像のパス
	\item 描画する輪郭のリスト
	\item 第二引数のうち、描画する輪郭のインデックス($-1$を指定することで、全輪郭を描画する)
	\item 輪郭を描画する線のRGBカラーを示すタプル
	\item 輪郭を描画する線の太さ
\end{enumerate}
本研究では、文字情報取得用画像処理(\ref{subsec:image_processing_for_char_recognition}節で後述)で白色の矩形と直線を描画するためと、領域強調画像出力処理(\ref{subsec:area_highlighted_image_output_processing}節で後述)で矩形領域と下線部領域を描画するために用いる。

\paragraph{putText関数}
putText関数は、文字を画像に描画する関数である。
本研究では、領域強調画像出力処理(\ref{subsec:area_highlighted_image_output_processing}節で後述)で領域とラベルを描画するために用いる。

\section{DeblurGANv2}\label{sec:DeblurGANv2}
DeblurGANv2は、敵対的生成ネットワーク(GAN)をブレ除去に適用したツールである\cite{DeblurGANv2}。
スマートフォンで帳票画像を撮影する際に発生する画像内のブレを除去し、領域座標と文字認識の精度を高めることを目的として適用する。
また、先行研究において、スマートフォンのカメラで撮影した画像に対して、複数の画像処理と共にDeblurGANv2を適用することによって、ブレ除去によって画像品質が向上し、Tesseract-OCR\cite{Tesseract-OCR}を用いた光学文字認識(\ref{sec:Optical-Charactor-Recognition}節で後述)の精度が向上することが示されている\cite{DeblurGANv2の先行研究}。
本研究では、領域取得部(\ref{sec:area_coords_obtainment_part}節で後述)と文字情報取得部(\ref{sec:OCR_part}節で後述)で施す画像処理の1つとして用いる。


\section{光学文字認識}\label{sec:Optical-Charactor-Recognition}
光学文字認識(Optical Charactor Recognition)とは、文字を含む画像から文字コードに変換することである\cite{光学文字認識}。
本研究では、文字情報取得処理(\ref{subsec:char_information_obtainment_processing}で後述)で、文字と、文字を囲むバウンディングボックスの各頂点のxy座標を取得するために用いる。
また、本研究では、光学文字認識ソフトウェア\cite{光学文字認識ソフトウェア}であるTesseract-OCRを、PythonのOCR用のラッパーライブラリであるPyOCR\cite{PyOCR}から用いる。
PyOCRを用いることにより、文字を認識する処理にbuilderという変数をパラメータとして指定できる。
本研究では、LineBoxBuilderを変数builderに指定し、行単位で文字と、文字を囲むバウンディングボックスの各頂点のxy座標を同時に取得する。

\section{Fugashi}\label{sec:Fugashi}
Fugashiは、形態素解析ソフトウェアであるMecab\cite{Mecab}をPython\cite{Python}で使用する際のラッパーライブラリである\cite{Fugashi}。
本研究では、除外判定処理(\ref{subsec:exclusion_judgement_processing}節で後述)で属性判定に不要な取得文字を、取得文字を構成する形態素の品詞を参照することによって、出力の対象外とするために用いる。
また、本研究でFugashiの解析に用いる辞書として、UniDic\cite{UniDic}を利用する。
よって、本論文で記述する品詞体系についてはUniDic品詞体系とする。
UniDic品詞体系では、左からカンマ区切りで、大分類、中分類、小分類、細分類の順で品詞を列挙する\cite{UniDic品詞体系}。


\section{Youri}\label{sec:Youri}
Youriは、Llama2\cite{Llama2}を日本語の学習データで継続事前学習を行うことによって、日本語のテキスト生成能力を高めた大規模言語モデルである\cite{Youri}。
本研究では、属性推測処理(\ref{subsec:att_prediction_processing}節で後述)で取得文字の属性を判定するために用いる。