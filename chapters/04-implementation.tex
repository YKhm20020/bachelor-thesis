\chapter{\toolName の実装}\label{cha:Implementation}
以下簡単なメモ。修正および加筆予定。
\toolName は、領域座標取得部、文字情報取得部、ラベル付与部で構成されている。


\section{領域座標取得部}\label{sec:area_coords_obtainment_part}
領域座標取得部は、帳票画像内の記入欄を検知し、領域座標として出力する。記入欄は、矩形または下線で示しているものを対象する。


\subsection{矩形領域座標取得機能}\label{subsec:rect_coords_obtainment}
矩形領域座標取得機能では、矩形の記入欄を検知し、各頂点のx, y座標を矩形領域座標として取得し、出力する機能である。まず、以下の順で画像処理を施す。

\begin{enumerate}[label=(\arabic*)]
    \item DeblurGANv2 の適用
    \item 入力画像のグレースケール化
    \item ガウシアンフィルタの適用
    \item 大津法による二値化
    \item findContours 関数による輪郭検出
\end{enumerate}

画像処理後、findContours 関数による輪郭検出を用いて矩形領域座標を取得する。
なお、以下のいずれかにあてはまる矩形については、出力の対象外とする。

\begin{itemize}
    \item 面積が3000px以下である場合
    \item ある辺の長さが10px以下である場合
\end{itemize}


\subsection{下線部領域座標取得機能}\label{subsec:underline_coords_obtainment}
下線部領域取得機能では、下線部の記入欄を検知し、両端点のx, y座標を下線部領域座標として取得し、出力する機能である。まず、以下の順で画像処理を施す。

\begin{enumerate}[label=(\arabic*)]
    \item DeblurGANv2 の適用
    \item 入力画像のグレースケール化
    \item ガウシアンフィルタの適用
    \item 大津法による二値化
    \item 膨張処理の適用
    \item Canny 法によるエッジ検出
\end{enumerate}

以上の画像処理を施した後に、ハフ変換を用いて直線を両端点のx, y座標を取得する。
なお、以下のいずれかに該当する直線については、出力の対象外とする。

\begin{itemize}
    \item 直線の長さが10px未満である場合
    \item 傾きが3px以上である場合
    \item 矩形領域の辺の一部である場合
\end{itemize}



\section{文字情報取得部}\label{sec:OCR_part}
文字情報取得部では、光学文字認識ソフト Tesseract-OCR を用いて、文字と、文字を囲うバウンディングボックスを文字位置として取得する。
文字情報取得部の出力結果は、後述するラベル付与部で用いる。

\subsection{文字認識機能}\label{subsec:char_recognition}
文字認識機能では、検出した文字を取得する。取得文字は、後述するラベル付与部の属性推測機能で用いる。まず、以下の順で画像処理を施す。

\begin{enumerate}[label=(\arabic*)]
    \item DeblurGANv2 の適用
    \item 入力画像のグレースケール化
    \item 大津法による二値化
\end{enumerate}

画像処理後に、Tesseract-OCR による文字認識を行う。

\subsection{文字位置取得機能}\label{subsec:char_position_obtainment}
文字位置取得機能では、検出した文字を囲うバウンディングボックスの頂点座標を文字位置として取得する。
前述の文字認識機能における文字認識にて、同時にバウンディングボックスの頂点座標を取得する。
取得したバウンディングボックスの頂点座標は、後述するラベル付与部のラベル割付機能で用いる。


\section{ラベル付与部}\label{sec:label_link_part}
ラベル付与部では、取得した領域に対し、日付、文字列、数値の3つのラベルのいずれかを付与する。


\subsection{属性推測機能}\label{subsec:att_prediction}
属性推測機能では、取得文字に対して、日付、文字列、数値の3つの属性のいずれにあてはまるかを推測する。
属性の推測には、大規模言語モデル Youri を用いる。

\subsection{ラベル割付機能}\label{subsec:label_link}
ラベル割付機能では、取得した領域に対し、日付、文字列、数値の3つのラベルのいずれかを割り付ける。
属性推測機能で推測した属性と、文字位置取得機能で取得したバウンディングボックスの頂点座標をもとに、取得文字近傍の領域に対して、推測した属性を割り付ける。
